// Generated by CoffeeScript 1.6.3
/* (c) 2013 Maxim Litvinov*/(function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},t=8,n=8,r=7,i=Math.PI/180,s=["blue","magenta","red","orange","yellow","green","white"],o=function(e){return e.preventDefault()},u=function(){},a=function(){function i(){var e,t,n,r,i=this;this.canvas=document.getElementById("canvas");this.ctx=this.canvas.getContext("2d");this.ctx.translate(.5,.5);this.audio={};r=["hit","coin","fill"];for(t=0,n=r.length;t<n;t++){e=r[t];this.audio[e]=new Audio("audio/"+e+".wav")}this.reset();this.canvas.onmousemove=function(e){return i.move(e)};this.canvas.onmousedown=function(e){return i.mousedown(e)};this.canvas.onmouseup=function(e){return i.mouseup(e)};this.canvas.onclick=u;window.onresize=function(e){return i.resize(e)};document.ontouchstart=o;document.ontouchmove=o;document.onmousewheel=o}i.prototype.reset=function(){var e,i;this.playing=!0;this.won=!1;this.state=[];this.state=function(){var s,o=[];for(e=s=0;0<=t?s<t:s>t;e=0<=t?++s:--s)o.push(function(){var e,t=[];for(i=e=0;0<=n?e<n:e>n;i=0<=n?++e:--e)t.push(Math.random()*r|0);return t}());return o}();this.resize();return this.tryRemove()};i.prototype.resize=function(){var e,r;$("html").height(window.innerHeight);window.scrollTo(0,0);r=$("div").get(0).offsetWidth;e=$("div").get(0).offsetHeight;console.log(r,e);this.u=Math.min(r/t,e/n)&-2;this.canvas.width=this.w=this.u*t|0;this.canvas.height=this.h=this.u*n|0;this.offset=$(this.canvas).offset();console.log(this.w,this.h,this.u);return this.draw()};i.prototype.userActive=function(){var e,t;if(!t){t=!0;e=$("audio").get(0);if(e.duration===0){e.load();return e.play()}}};i.prototype.getPos=function(e){return{x:Math.floor((e.clientX-this.offset.left)/this.u)|0,y:n-Math.ceil((e.clientY-this.offset.top)/this.u)|0}};i.prototype.checkMoves=function(){var e,r,i,s,o,u,a,f,l,c,h=function(){var t,n,i=this.state,s=[];for(t=0,n=i.length;t<n;t++){r=i[t];s.push(function(){var t,n,i=[];for(t=0,n=r.length;t<n;t++){e=r[t];i.push(e)}return i}())}return s}.call(this);for(i=o=0,l=t-1;0<=l?o<l:o>l;i=0<=l?++o:--o)for(s=u=0;0<=n?u<n:u>n;s=0<=n?++u:--u){this.swap(h,i,s,i+1,s);if(this.canRemove(h))return!0;this.swap(h,i,s,i+1,s)}for(i=a=0;0<=t?a<t:a>t;i=0<=t?++a:--a)for(s=f=0,c=n-1;0<=c?f<c:f>c;s=0<=c?++f:--f){this.swap(h,i,s,i,s+1);if(this.canRemove(h))return!0;this.swap(h,i,s,i,s+1)}};i.prototype.canRemove=function(e){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;for(u=f=0,v=t-2;0<=v?f<v:f>v;u=0<=v?++f:--f)for(a=l=0;0<=n?l<n:l>n;a=0<=n?++l:--l){r=e[u][a];o=1;for(i=c=m=u+1;m<=t?c<t:c>t;i=m<=t?++c:--c){if(e[i][a]!==r)break;o+=1}if(o>=3)return!0}for(u=h=0;0<=t?h<t:h>t;u=0<=t?++h:--h)for(a=p=0,g=n-2;0<=g?p<g:p>g;a=0<=g?++p:--p){r=e[u][a];o=1;for(s=d=y=a+1;y<=n?d<n:d>n;s=y<=n?++d:--d){if(e[u][s]!==r)break;o+=1}if(o>=3)return!0}return!1};i.prototype.tryRemove=function(){var e,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T=this,N={};for(a=l=0,y=t-2;0<=y?l<y:l>y;a=0<=y?++l:--l)for(f=c=0;0<=n?c<n:c>n;f=0<=n?++c:--c){e=this.state[a][f];u=1;for(r=h=b=a+1;b<=t?h<t:h>t;r=b<=t?++h:--h){if(this.state[r][f]!==e)break;u+=1}if(u>=3){console.log(a,f,"horz",u);for(r=p=a,w=a+u;a<=w?p<w:p>w;r=a<=w?++p:--p)N[r+"x"+f]={x:r,y:f}}}for(a=d=0;0<=t?d<t:d>t;a=0<=t?++d:--d)for(f=v=0,E=n-2;0<=E?v<E:v>E;f=0<=E?++v:--v){e=this.state[a][f];u=1;for(i=m=S=f+1;S<=n?m<n:m>n;i=S<=n?++m:--m){if(this.state[a][i]!==e)break;u+=1}if(u>=3){console.log(a,f,"vert",u);for(i=g=f,x=f+u;f<=x?g<x:g>x;i=f<=x?++g:--g)N[a+"x"+i]={x:a,y:i}}}o=0;for(s in N){e=N[s];console.log("deleting",e.x,e.y);delete this.state[e.x][e.y];o+=1}console.log(o);if(o){this.audio.coin.play();this.removing||(this.removing=setTimeout(function(){T.removing=null;return T.fillNew()},500))}this.draw();return o>0};i.prototype.fillNew=function(){var e,t,i=this;for(t in this.state)this.state[t]=function(){var n,r,i=this.state[t],s=[];for(n=0,r=i.length;n<r;n++){e=i[n];e!=null&&s.push(e)}return s}.call(this);for(t in this.state)while(this.state[t].length<n)this.state[t].push(Math.random()*r|0);this.audio.fill.play();this.draw();this.checkMoves()||this.gameover();return setTimeout(function(){return i.tryRemove()},500)};i.prototype.swap=function(e,t,n,r,i){var s=e[t][n];e[t][n]=e[r][i];return e[r][i]=s};i.prototype.trySwap=function(e,t,n,r){this.swap(this.state,e,t,n,r);if(!this.tryRemove()){this.audio.hit.play();return this.swap(this.state,e,t,n,r)}};i.prototype.mousedown=function(e){this.userActive();if(this.playing)return this.start=this.getPos(e)};i.prototype.mouseup=function(e){var t,n,r;if(!this.playing){this.reset();return}r=this.getPos(e);t=r.x-this.start.x;n=r.y-this.start.y;if(t===0&&n===0)return;return Math.abs(t)>Math.abs(n)?this.trySwap(this.start.x,this.start.y,this.start.x+(t>0?1:-1),this.start.y):this.trySwap(this.start.x,this.start.y,this.start.x,this.start.y+(n>0?1:-1))};i.prototype.move=function(r){var i,s,o,u,a;if(!this.playing)return;i=this.getPos(r);(s=i.x,e.call(function(){var e;u=[];for(e=0;0<=t?e<t:e>t;0<=t?e++:e--)u.push(e);return u}.apply(this),s)>=0)&&(o=i.y,e.call(function(){var e;a=[];for(e=0;0<=n?e<n:e>n;0<=n?e++:e--)a.push(e);return a}.apply(this),o)>=0)?this.selected=i:this.selected=null;return this.draw()};i.prototype.gameover=function(){return this.playing=!1};i.prototype.win=function(){this.playing=!1;return this.won=!0};i.prototype.draw=function(){var e,r,i,o,u,a,f,l,c,h,p,d,v,m,g;this.ctx.clearRect(0,0,this.w,this.h);this.ctx.strokeStyle="grey";this.ctx.lineWidth=1;this.ctx.strokeRect(0,0,t*this.u,n*this.u);m=this.state;for(f=c=0,d=m.length;c<d;f=++c){i=m[f];for(l=h=0,v=i.length;h<v;l=++h){r=i[l];if(r==null)continue;this.ctx.fillStyle=s[r];this.ctx.beginPath();this.ctx.moveTo(this.u*(f+.5),this.u*(n-l-.95));for(a=p=1,g=r+3;1<=g?p<g:p>g;a=1<=g?++p:--p){e=Math.PI*2*a/(r+3);o=.45*Math.sin(e);u=-0.45*Math.cos(e);this.ctx.lineTo(this.u*(f+.5+o),this.u*(n-l-.5+u))}this.ctx.closePath();this.selected!=null&&this.selected.x===f&&this.selected.y===l?this.ctx.globalAlpha=.6:this.ctx.globalAlpha=.8;this.ctx.fill();this.ctx.globalAlpha=1;this.ctx.strokeStyle="gray";this.ctx.lineWidth=1;this.ctx.stroke()}}if(!this.playing){this.ctx.font="bold "+this.u*n*.1+"px sans-serif";this.ctx.lineWidth=2;this.ctx.textAlign="center";this.ctx.textBaseline="middle";if(this.won){this.ctx.strokeStyle="yellow";this.ctx.fillStyle="green";this.ctx.fillText("YOU WIN!",this.w/2,this.h/2);return this.ctx.strokeText("YOU WIN!",this.w/2,this.h/2)}this.ctx.strokeStyle="darkred";this.ctx.fillStyle="red";this.ctx.fillText("GAME OVER",this.w/2,this.h/2);return this.ctx.strokeText("GAME OVER",this.w/2,this.h/2)}};return i}();$(function(){return new a})}).call(this);