// Generated by CoffeeScript 1.6.3
/* (c) 2013 Maxim Litvinov*/(function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},t=20,n=20,r=3,i=Math.PI/180,s=["red","blue","gold","green"],o=!1,u=function(){function i(){var e,t,n,r,i=this;this.canvas=document.getElementById("canvas");this.ctx=this.canvas.getContext("2d");this.ctx.translate(.5,.5);this.canvas.onmousemove=function(e){return i.move(e)};this.canvas.onclick=function(e){return i.click(e)};window.onresize=function(e){return i.resize(e)};this.audio={};r=["hit"];for(t=0,n=r.length;t<n;t++){e=r[t];this.audio[e]=new Audio("audio/"+e+".wav")}this.reset()}i.prototype.reset=function(){var e,i;this.playing=!0;this.won=!1;this.state=[];while(!this.canRemoveAny())this.state=function(){var s,o=[];for(e=s=0;0<=t?s<t:s>t;e=0<=t?++s:--s)o.push(function(){var e,t=[];for(i=e=0;0<=n?e<n:e>n;i=0<=n?++e:--e)t.push(Math.random()*r|0);return t}());return o}();return this.resize()};i.prototype.resize=function(){this.w=this.canvas.width=this.canvas.offsetWidth;this.h=this.canvas.height=this.canvas.offsetHeight;this.u=Math.min(this.w/t,this.h/n)&-2;this.x0=(this.w-this.u*t)/2|0;this.y0=(this.h-this.u*n)/2|0;console.log(this.w,this.h,this.u,this.x0,this.y0);return this.draw()};i.prototype.move=function(r){var i,s,o,u,a;if(!this.playing)return;i=$(this.canvas).offset();s=Math.floor((r.pageX-i.top-this.x0)/this.u);o=n-Math.ceil((r.pageY-i.top-this.y0)/this.u);e.call(function(){var e;u=[];for(e=0;0<=t?e<t:e>t;0<=t?e++:e--)u.push(e);return u}.apply(this),s)>=0&&e.call(function(){var e;a=[];for(e=0;0<=n?e<n:e>n;0<=n?e++:e--)a.push(e);return a}.apply(this),o)>=0?this.selected={x:s,y:o}:this.selected=null;return this.draw()};i.prototype.click=function(t){var r,i,s,u,a,f;if(!o){o=!0;r=$("audio").get(0);if(r.duration===0||r.paused){r.load();r.play()}}if(!this.playing){this.reset();return}i=$(this.canvas).offset();s=Math.floor((t.pageX-i.top-this.x0)/this.u);u=n-Math.ceil((t.pageY-i.top-this.y0)/this.u);if(e.call(function(){var e,t;a=[];for(e=0,t=this.state.length;0<=t?e<t:e>t;0<=t?e++:e--)a.push(e);return a}.apply(this),s)>=0&&e.call(function(){var e,t;f=[];for(e=0,t=this.state[s].length;0<=t?e<t:e>t;0<=t?e++:e--)f.push(e);return f}.apply(this),u)>=0){if(this.tryRemove(s,u)){this.collapse();this.canRemoveAny()||this.gameover();this.state.length||this.win();return this.draw()}return this.audio.hit.play()}};i.prototype.gameover=function(){return this.playing=!1};i.prototype.win=function(){this.playing=!1;return this.won=!0};i.prototype.tryRemove=function(e,t){var n,r,i=function(){var e,t,i=this.state,s=[];for(e=0,t=i.length;e<t;e++){r=i[e];s.push(function(){var e,t,i=[];for(e=0,t=r.length;e<t;e++){n=r[e];i.push(n)}return i}())}return s}.call(this),s=this.remove(e,t);if(s<3){this.state=i;return!1}return!0};i.prototype.canRemoveAny=function(){var e,t,n,r,i,s,o,u,a,f,l=this.state;for(i=o=0,a=l.length;o<a;i=++o){n=l[i];for(s=u=0,f=n.length;u<f;s=++u){t=n[s];e=function(){var e,r,i=this.state,s=[];for(e=0,r=i.length;e<r;e++){n=i[e];s.push(function(){var e,r,i=[];for(e=0,r=n.length;e<r;e++){t=n[e];i.push(t)}return i}())}return s}.call(this);r=this.remove(i,s);this.state=e;if(r>=3)return!0}}return!1};i.prototype.remove=function(t,r,i){var s,o;i==null&&(i=this.state[t][r]);if(e.call(function(){var e,t;s=[];for(e=0,t=this.state.length;0<=t?e<t:e>t;0<=t?e++:e--)s.push(e);return s}.apply(this),t)>=0&&e.call(function(){var e;o=[];for(e=0;0<=n?e<n:e>n;0<=n?e++:e--)o.push(e);return o}.apply(this),r)>=0&&this.state[t][r]===i){delete this.state[t][r];return 1+this.remove(t-1,r,i)+this.remove(t+1,r,i)+this.remove(t,r-1,i)+this.remove(t,r+1,i)}return 0};i.prototype.collapse=function(){var e,t,n;for(n in this.state)this.state[n]=function(){var t,r,i=this.state[n],s=[];for(t=0,r=i.length;t<r;t++){e=i[t];e!=null&&s.push(e)}return s}.call(this);return this.state=function(){var e,n,r=this.state,i=[];for(e=0,n=r.length;e<n;e++){t=r[e];t.length&&i.push(t)}return i}.call(this)};i.prototype.draw=function(){var e,r,i,o,u,a,f,l,c;this.ctx.clearRect(0,0,this.w,this.h);this.ctx.strokeStyle="grey";this.ctx.lineWidth=1;this.ctx.strokeRect(this.x0,this.y0,t*this.u,n*this.u);c=this.state;for(i=u=0,f=c.length;u<f;i=++u){r=c[i];for(o=a=0,l=r.length;a<l;o=++a){e=r[o];if(e==null)continue;this.ctx.fillStyle=s[e];this.ctx.beginPath();this.ctx.rect(this.x0+this.u*(i+.05),this.y0+this.u*(n-o-.95),this.u*.9,this.u*.9);this.ctx.fill();if(this.selected!=null&&this.selected.x===i&&this.selected.y===o){this.ctx.lineWidth=2;this.ctx.stroke()}}}if(!this.playing){this.ctx.font="bold "+this.u*n*.1+"px sans-serif";this.ctx.lineWidth=2;this.ctx.textAlign="center";this.ctx.textBaseline="middle";if(this.won){this.ctx.strokeStyle="yellow";this.ctx.fillStyle="green";this.ctx.fillText("YOU WIN!",this.w/2,this.h/2);return this.ctx.strokeText("YOU WIN!",this.w/2,this.h/2)}this.ctx.strokeStyle="darkred";this.ctx.fillStyle="red";this.ctx.fillText("GAME OVER",this.w/2,this.h/2);return this.ctx.strokeText("GAME OVER",this.w/2,this.h/2)}};return i}();$(function(){return new u})}).call(this);